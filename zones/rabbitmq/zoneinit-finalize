echo "99 finalizing rabbitmq pkg"

#
# Erlang prior to R15B always binds to CPUs by default. To deal with
# this we need to explicitly tell Erlang not to bind to CPUs.
#
echo 'SERVER_ERL_ARGS="$SERVER_ERL_ARGS +sbt u"' \
    >> /opt/local/etc/rabbitmq/rabbitmq-env.conf


# Setup .erlang.cookie symlink
if [[ ! -L /root/.erlang.cookie ]]; then
	ln -s /var/db/rabbitmq/.erlang.cookie /root/.erlang.cookie
fi

# Apply configuration from /opt/smartdc/etc/zoneconfig now
source /opt/smartdc/bin/configure.sh

/usr/sbin/projadd -c "Rabbitmq settings" -U rabbitmq -G rabbitmq \
    -K "process.max-file-descriptor=(basic,65535,deny)" \
    rabbitmq
/usr/sbin/svccfg -s rabbitmq setprop method_context/project=rabbitmq
/usr/sbin/svcadm refresh rabbitmq

su - rabbitmq -c "/opt/local/sbin/rabbitmqctl -n rabbit@$(zonename) stop"

/usr/sbin/svcadm disable rabbitmq
# HOME must be set for 'erlexec' (used in rabbitmq-plugins)
export HOME=/root
rabbitmq-plugins enable rabbitmq_management
/usr/sbin/svcadm enable rabbitmq

#
# Call mdns_announce (imported from 97-zoneinit-common) to announce our
# service.
#
mdns_announce RabbitMQ 5672 _amqp-broker
