#!/usr/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

eval $(cat /opt/smartdc/etc/zoneconfig)

function cafail
{
	echo "fatal: $*" >&2
	exit 1
}

function casetprop
{
	local svc=$1 prop=$2 value=$3
	[[ -n $value ]] || cafail "no value specified for $svc $prop"
	svccfg -s $svc setprop com.joyent.ca,$prop = \
	    astring: "$value" || cafail "failed to set $svc $prop = $val"
}

configure()
{
	#
	# Update the SMF configuration to reflect this headnode's configuration.
	#
	svcadm disable -s caconfigsvc:default || \
	    cafail "failed to disable configsvc"
	casetprop caconfigsvc:default caconfig/amqp-host "$CA_AMQP_HOST"
	casetprop caconfigsvc:default caconfig/mapi-host "$CA_MAPI_HOST"
	casetprop caconfigsvc:default caconfig/mapi-port "$CA_MAPI_PORT"
	casetprop caconfigsvc:default caconfig/mapi-user "$CA_MAPI_USER"
	casetprop caconfigsvc:default caconfig/mapi-password "$CA_MAPI_PASSWORD"
	svcadm refresh caconfigsvc:default || \
	    cafail "failed to refresh configsvc"
	svcadm enable -s caconfigsvc:default || \
	    cafail "failed to re-enable configsvc"

	fmris="$(svcs -H -ofmri caaggsvc) $(svcs -H -ofmri castashsvc)"
	for fmri in $fmris; do
		svcadm disable -s $fmri || cafail "failed to disable $fmri"
		casetprop $fmri caconfig/amqp-host "$CA_AMQP_HOST"
		svcadm refresh $fmri || cafail "failed to refresh $fmri"
		svcadm enable -s $fmri || cafail "failed to re-enable $fmri"
	done
}

# The user-script is downloaded and executed on every zone boot. We take
# advantage of this to maintain the cached config values post-setup.
if [ -e /var/svc/setup_complete ]; then
	oldpw=`nawk -F= '{
	    if ($1 == "CA_MAPI_PASSWORD")
		print substr($2, 2, length($2) - 2)
	}' /opt/smartdc/etc/zoneconfig`
	[ "$mapi_http_admin_pw" == "$oldpw" ] && exit 0

	echo "Updating ca configuration"
	nawk -F= -v p=$mapi_http_admin_pw '{
	    if ($1 == "CA_MAPI_PASSWORD")
                printf("CA_MAPI_PASSWORD=\047%s\047\n", p)
	    else
                print $0
	}' /opt/smartdc/etc/zoneconfig > /opt/smartdc/etc/zoneconfig.new
	mv /opt/smartdc/etc/zoneconfig.new /opt/smartdc/etc/zoneconfig
	configure
	svcadm restart \
		caaggsvc:auto0 \
		castashsvc:default \
		caaggsvc:auto1 \
		caconfigsvc:default
fi

configure

exit 0
