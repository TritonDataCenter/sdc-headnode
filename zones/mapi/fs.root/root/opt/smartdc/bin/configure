#!/usr/bin/bash

# Before to proceed, ensure we disable all the smartdc services on the zone:
# (I know the capi_ipf_setup is not needed here, but trying to write something
# we can actually use for any of the ruby zones)
echo "Disabling application services"
services=$(/usr/bin/svcs -a -o FMRI|grep smartdc)
for service in $services; do
  if [[ ( $service != 'svc:/system/filesystem/smartdc:default' ) && ( $service != "svc:/platform/smartdc/capi_ipf_setup:default" ) ]]; then
      $(/usr/sbin/svcadm disable -s "$service")
  fi
done

# Source configuration file first:
source /opt/smartdc/bin/zoneconfig

# Then, source the configure.sh script:
source /opt/smartdc/bin/configure.sh

# Re-enable our services post re-configuration:
for service in $services; do
  if [[ ( $service != 'svc:/system/filesystem/smartdc:default' ) && ( $service != "svc:/platform/smartdc/capi_ipf_setup:default" ) ]]; then
      $(/usr/sbin/svcadm enable -s "$service")
  fi
done
# And exit:
exit 0
