echo -n "mapi/mapi-data, " >>/dev/console
# We don't want to create the dataset if it already exists and it is on a
# known path:
if [[ -f "${USB_COPY}/backup/mapi-data.zfs" ]]; then
  zfs receive zones/mapi/mapi-data < "${USB_COPY}/backup/mapi-data.zfs"
  # Remove the snapshot created when received the zfs file:
  DATA_DS_SNAP=$(zfs list -t snapshot -H -o name|grep "mapi\/mapi-data@")
  zfs destroy ${DATA_DS_SNAP}
else
  zfs create zones/mapi/mapi-data
fi

zonecfg -z mapi 'add dataset; set name="zones/mapi/mapi-data"; end; verify; commit'
STAMP=$(cat /zones/mapi/root/opt/smartdc/mapi-VERSION)
echo -n "mapi/mapi-app-${STAMP} " >>/dev/console
zfs create zones/mapi/mapi-app-${STAMP}
echo "$STAMP">/zones/mapi/root/root/mapi-app-timestamp
cmd="add dataset; set name=zones/mapi/mapi-app-$STAMP; end; verify; commit"
zonecfg -z mapi $cmd
echo -n ". " >> /dev/console
# Trying to do not add an extra file to copy agents script to mapi zone
mkdir -p /zones/mapi/root/opt/smartdc/agent-scripts
cp ${USB_COPY}/ur-scripts/*.sh /zones/mapi/root/opt/smartdc/agent-scripts/
mkdir -p /zones/mapi/root/opt/smartdc/joysetup
cp ${USB_COPY}/scripts/joysetup.sh /zones/mapi/root/opt/smartdc/joysetup/
# copy headnode info into zone if we're MAPI
sysinfo > /zones/mapi/root/opt/smartdc/headnode-sysinfo.json

# Datasets
mkdir -p /zones/mapi/root/opt/smartdc/datasets
cp -R ${USB_COPY}/datasets/*.dsmanifest /zones/mapi/root/opt/smartdc/datasets
