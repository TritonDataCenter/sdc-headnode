#!/usr/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

PATH=/usr/bin:/usr/sbin
export PATH

if [[ $# != 2 ]]; then
    echo "Usage: $0 <zone_name> <src_directory>"
    exit 1
fi

ROLE=cloudapi
UUID=$1
SRC_DIR=$2
CFG_FILE=/zones/${UUID}/root/opt/smartdc/cloudapi/cfg/config.json

# Older backups may not have had this zone
if [[ ! -d "${SRC_DIR}/${ROLE}" ]]; then
	echo "Warning, backup missing $ROLE"
	echo "==> Done"
	exit 0
fi

if [[ ! -f "${SRC_DIR}/${ROLE}/config.json" ]]; then
	echo "Warning, backup missing config file for $ROLE"
	echo "==> Done"
	exit 0
fi

echo "==> Restoring config file for zone '${ROLE}'"
cp ${SRC_DIR}/${ROLE}/config.json $CFG_FILE

mkdir -p /zones/${UUID}/root/opt/smartdc/cloudapi/plugins
if [[ -d "${SRC_DIR}/${ROLE}/plugins" ]]; then
    for i in `ls ${SRC_DIR}/${ROLE}/plugins`
    do
        if [ ! -f /zones/${UUID}/root/opt/smartdc/cloudapi/plugins/$i ]; then
            echo "==> Restoring plugin $i for zone '${ROLE}'"
            cp -p ${SRC_DIR}/${ROLE}/plugins/$i \
                /zones/${UUID}/root/opt/smartdc/cloudapi/plugins
        fi
    done
fi

echo "==> Done"
exit 0
