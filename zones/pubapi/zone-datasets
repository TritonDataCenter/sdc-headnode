printf "%-56s" "Creating zone pubapi-data..." >>/dev/console
# We don't want to create the dataset if it already exists and it is on a
# known path:
if [[ -f "${USB_COPY}/backup/pubapi-data.zfs" ]]; then
  zfs receive zones/pubapi/pubapi-data < "${USB_COPY}/backup/pubapi-data.zfs"
  # Remove the snapshot created when received the zfs file:
  DATA_DS_SNAP=$(zfs list -t snapshot -H -o name|grep "pubapi\/pubapi-data@")
  zfs destroy ${DATA_DS_SNAP}
else
  zfs create zones/pubapi/pubapi-data
fi
printf "%4s\n" "done" >>/dev/console

zonecfg -z pubapi 'add dataset; set name="zones/pubapi/pubapi-data"; end; verify; commit'
STAMP=$(cat /zones/pubapi/root/opt/smartdc/pubapi-VERSION)
printf "%-56s" "Creating zone pubapi-app-${STAMP}..." >>/dev/console
zfs create zones/pubapi/pubapi-app-${STAMP}
echo "$STAMP">/zones/pubapi/root/root/pubapi-app-timestamp
cmd="add dataset; set name=zones/pubapi/pubapi-app-$STAMP; end; verify; commit"
zonecfg -z pubapi $cmd
printf "%4s\n" "done" >>/dev/console
