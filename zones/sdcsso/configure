#!/usr/bin/bash
#
# Copyright (c) 2012 Joyent Inc., All rights reserved.
#

set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

eval $(cat /opt/smartdc/etc/zoneconfig)

echo "Updating SMF manifest"
$(/opt/local/bin/gsed -i"" -e "s/@@PREFIX@@/\/opt\/smartdc\/sdcsso/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@UFDSURL@@/${UFDS_ADMIN_IPS}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@UFDSROOTDN@@/${SDCSSO_LDAP_ROOT_DN}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@UFDSPASSWORD@@/${SDCSSO_LDAP_BIND_PASSWORD}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@KEYAPIHOST@@/${SDCSSO_KEYAPIHOST}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@KEYAPIPORT@@/${SDCSSO_KEYAPIPORT}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@SSLKEY@@/${SDCSSO_SSLKEY}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)
$(/opt/local/bin/gsed -i"" -e "s/@@SSLCERT@@/${SDCSSO_SSLCERT}/g" /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml)

echo "Importing sdcsso.xml"
/usr/sbin/svccfg import /opt/smartdc/sdcsso/smf/manifests/sdcsso.xml

exit 0
