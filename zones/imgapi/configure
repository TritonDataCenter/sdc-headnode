#!/usr/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

eval $(cat /opt/smartdc/etc/zoneconfig)

# for now just take the first IP
UFDS_ADMIN_IP=$(echo "${UFDS_ADMIN_IPS}" | tr ',' ' ')

# Mount our delegate dataset at '/data'.
zfs set mountpoint=/data zones/$(zonename)/data

# Note: Usage of "local" storage is only intended for bootstrapping.
# Manta and/or DCLS will be required for full functionality.
LOCAL_DB_DIR=/data/imgapi/images
if [[ ! -d $LOCAL_DB_DIR ]]; then
    echo "Create local db dir, $LOCAL_DB_DIR."
    mkdir -p $LOCAL_DB_DIR
    chown nobody:nobody $LOCAL_DB_DIR
fi

echo "Generating public key for imgapi"
if [[ ! -f /root/.ssh/id_rsa ]]; then
    # Generate key only the first time
    /usr/bin/ssh-keygen -t rsa -f /root/.ssh/id_rsa -N ""
fi
MANTA_KEY_ID=`ssh-keygen -l -f /root/.ssh/id_rsa.pub | awk '{print $2}' | tr -d '\n'`


echo "Creating IMGAPI config file"
cat > /opt/smartdc/imgapi/etc/imgapi.config.json <<HERE
{
    "port": 80,
    "logLevel": "debug",
    "mode": "dc",
    "database": {
        "type": "ufds",
        "url": "ldaps://${UFDS_ADMIN_IP}",
        "rootDn": "${UFDS_LDAP_ROOT_DN}",
        "password": "${UFDS_LDAP_ROOT_PW}"
    },
    "storage": {
        "local": {
            "dir": "${LOCAL_DB_DIR}"
        }
    }
}
HERE

echo "Updating SMF manifest"
$(/opt/local/bin/gsed -i"" -e "s/@@PREFIX@@/\/opt\/smartdc\/imgapi/g" /opt/smartdc/imgapi/smf/manifests/imgapi.xml)

echo "Importing imgapi.xml"
/usr/sbin/svccfg import /opt/smartdc/imgapi/smf/manifests/imgapi.xml

exit 0
