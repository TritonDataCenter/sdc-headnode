#!/usr/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

eval $(cat /opt/smartdc/etc/zoneconfig)

# for now just take the first IP
UFDS_ADMIN_IP=$(echo "${UFDS_ADMIN_IPS}" | tr ',' ' ')

echo "Creating IMGAPI config file"
cat > /opt/smartdc/imgapi/etc/imgapi.config.json <<HERE
{
  "port": 80,
  "logLevel": "debug",
  "ufds": {
    "url": "ldaps://${UFDS_ADMIN_IP}",
    "rootDn": "${UFDS_LDAP_ROOT_DN}",
    "password": "${UFDS_LDAP_ROOT_PW}"
  }
}
HERE

echo "Updating SMF manifest"
$(/opt/local/bin/gsed -i"" -e "s/@@PREFIX@@/\/opt\/smartdc\/imgapi/g" /opt/smartdc/imgapi/smf/manifests/imgapi.xml)

echo "Importing imgapi.xml"
/usr/sbin/svccfg import /opt/smartdc/imgapi/smf/manifests/imgapi.xml

exit 0
