#!/usr/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

eval $(cat /opt/smartdc/etc/zoneconfig)

# for now just take the first IP
UFDS_ADMIN_IP=$(echo "${UFDS_ADMIN_IPS}" | tr ',' ' ')
WF_URL=http://$(echo "${WORKFLOW_ADMIN_IPS}" | cut -d',' -f1)

# Mount our delegate dataset at '/data'.
zfs set mountpoint=/data zones/$(zonename)/data

# Note: Usage of "local" storage is only intended for bootstrapping.  Manta will
# be required for full functionality.
LOCAL_DB_DIR=$(json -f ${METADATA} LOCAL_DB_DIR)
if [[ ! -d $LOCAL_DB_DIR ]]; then
    echo "Create local db dir, $LOCAL_DB_DIR."
    mkdir -p $LOCAL_DB_DIR
    chown nobody:nobody $LOCAL_DB_DIR
fi

echo "Updating SMF manifest"
$(/opt/local/bin/gsed -i"" -e "s/@@PREFIX@@/\/opt\/smartdc\/imgapi/g" /opt/smartdc/imgapi/smf/manifests/imgapi.xml)

echo "Importing imgapi.xml"
/usr/sbin/svccfg import /opt/smartdc/imgapi/smf/manifests/imgapi.xml

exit 0
