#!/usr/bin/bash
#
# Copyright (c) 2012 Joyent Inc., All rights reserved.
#

export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o xtrace

PATH=/opt/smartdc/moray/build/node/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# This includes the fatal and sdc_[zk|manatee|moray|ufds]_check functions
source /var/svc/configure.common

eval $(cat /opt/smartdc/etc/zoneconfig)

role=moray

# XXX is net0 admin nic?
ADMIN_IPADDR=`ifconfig net0 | nawk '{if ($1 == "inet") print $2}'`
MORAY_MAIN_ADMIN_IP=$(echo "${MORAY_ADMIN_IPS}" | cut -d',' -f1)
ZK_MAIN_ADMIN_IP=$(echo "${ZOOKEPER_ADMIN_IPS}" | cut -d',' -f1)


ZONE_UUID=`/usr/bin/zonename`

echo "Updating config file"
CFG_FILE_IN=/opt/smartdc/$role/etc/config.json.in
CFG_FILE=/opt/smartdc/$role/etc/config.json

# Update config file
cp $CFG_FILE_IN $CFG_FILE
gsed -i -e "s|ZK_IP|$ZK_MAIN_ADMIN_IP|" $CFG_FILE

echo "Importing SMF Manifests"
$(/usr/sbin/svccfg import /opt/smartdc/$role/smf/manifests/$role.xml)

exit 0
