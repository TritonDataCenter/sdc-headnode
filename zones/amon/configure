#!/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

set -o xtrace

# This script is run to configure and reconfigure the amon zone.
PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

eval $(cat /opt/smartdc/etc/zoneconfig)

# Cookie to identify this as a SmartDC zone and its role
mkdir -p /var/smartdc/amon

# for now just take the first IP
UFDS_ADMIN_IP=$(echo "${UFDS_ADMIN_IPS}" | tr ',' ' ')
REDIS_ADMIN_IP=$(echo "${REDIS_ADMIN_IPS}" | tr ',' ' ')

mkdir -p /opt/smartdc/amon/cfg
cat > /opt/smartdc/amon/cfg/amon-master.json <<HERE
{
  "port": 80,
  "ufds": {
    "url": "ldaps://${UFDS_ADMIN_IP}",
    "rootDn": "${UFDS_LDAP_ROOT_DN}",
    "password": "${UFDS_LDAP_ROOT_PW}"
  },
  "mapi": {
    "url": "${MAPI_URL}",
    "username": "${MAPI_HTTP_ADMIN_USER}",
    "password": "${MAPI_HTTP_ADMIN_PW}"
  },
  "redis": {
    "host": "${REDIS_ADMIN_IP}",
    "port": "${REDIS_PORT}"
  },
  "datacenterName": "${DATACENTER_NAME}",
  "notificationPlugins": {
    "email": {
      "path": "./notifications/email",
      "config": {
        "smtp": {
          "host": "127.0.0.1",
          "port": 25,
          "ssl": false,
          "use_authentication": false
        },
        "from": "\"Monitoring\" <no-reply@joyent.com>"
      }
    }
  }
}
HERE

# Currently there aren't any vars to interpolate into 'amon-master.smf.in'.
echo "Importing Amon SMF manifest."
/usr/sbin/svccfg import /opt/smartdc/amon/smf/amon-master.smf.in

echo "Enabling 'amon-master' service."
/usr/sbin/svcadm enable smartdc/site/amon-master

exit 0
