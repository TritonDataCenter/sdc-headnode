#!/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin
PATH=/opt/smartdc/adminui/build/node/bin:$PATH

eval $(cat /opt/smartdc/etc/zoneconfig)

host=`hostname`

echo "Creating config.json from zoneconfig"
node /opt/smartdc/adminui/tools/create-config-from-zoneconfig /opt/smartdc/zoneconfig

echo "Creating HAPrgooxy config file"
cat > /opt/local/etc/haproxy.cfg <<HERE
global
        log 127.0.0.1 local0
        ulimit-n 4096
        user haproxy
        group haproxy
        daemon

defaults
        option ssl-hello-chk
        timeout connect 400ms
        timeout client 1m
        timeout server 5m

listen ufds_proxy 127.0.0.1:636
        mode tcp
        option tcplog
        log global
HERE

# Add all UFDS IPs to haproxy
# Mark the first one as not backup and all the others as backup
U=0
for ip in $(echo "${UFDS_ADMIN_IPS}" | tr ',' ' ')
do
  if [ $U == 0 ] ; then
    echo "        server ufds$U $ip:636 check" \
      >> /opt/local/etc/haproxy.cfg
  else
    echo "        server ufds$U $ip:636 check backup" \
      >> /opt/local/etc/haproxy.cfg
  fi

  let U+=1
done

echo "Importing haproxy service SMF"
svccfg import /opt/local/share/smf/manifest/haproxy.xml

echo "Updating adminui service manifest"
$(/opt/local/bin/gsed -i"" \
  -e "s/@@PREFIX@@/\/opt\/smartdc\/adminui/g" \
  /opt/smartdc/adminui/smf/manifests/zapi.xml)

echo "Importing adminui service manifest"
svccfg import /opt/smartdc/adminui/smf/manifests/adminui.xml

exit 0
