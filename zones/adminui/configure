#!/bin/bash
#
# Copyright (c) 2011 Joyent Inc., All rights reserved.
#

export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o xtrace

PATH=/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin
PATH=/opt/smartdc/adminui/build/node/bin:$PATH

eval $(cat /opt/smartdc/etc/zoneconfig)

host=`hostname`

echo "Creating config.json from zoneconfig"
(/opt/smartdc/adminui/build/node/bin/node \
  /opt/smartdc/adminui/tools/create-config-from-zoneconfig \
  /opt/smartdc/etc/zoneconfig \
  /opt/smartdc/adminui/etc/config.json)

echo "Updating adminui service manifest"
$(/opt/local/bin/gsed -i"" \
  -e "s/@@PREFIX@@/\/opt\/smartdc\/adminui/g" \
  /opt/smartdc/adminui/smf/manifests/adminui.xml)

echo "Importing adminui service manifest"
svccfg import /opt/smartdc/adminui/smf/manifests/adminui.xml

exit 0
