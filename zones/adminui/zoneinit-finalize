#!/bin/bash

svcadm clear network/physical:default >/dev/null 2>&1

echo "99 finalizing adminui zone"

app_name='adminui'

#
# Call symlink_ruby (imported from 97-zoneinit-common)
#
symlink_ruby

#
# Also, from 97-zoneinit-common
#
create_jill_account

# from zoneinit-common:
ruby_app_update_service $app_name

# Save the zoneconfig file on the configure dir (for testing purposes right now)
cat /root/zoneconfig > /opt/smartdc/bin/zoneconfig
# Source the configure.sh script now:
source /opt/smartdc/bin/configure.sh

echo "Importing MAPI Admin UI Unicorn Manifest"
/usr/sbin/svccfg import /opt/smartdc/adminui/config/unicorn.smf
sleep 1

# Ensure everything in /opt/smartdc is owned by jill
chown -R jill:jill /opt/smartdc

# fix perms on /home
chown root:root /home
chmod 0555 /home

if [[ ! $(/usr/bin/svcs -a|grep ${app_name}-update) ]]; then
  echo "Importing '${app_name}-update' service"
  $(/usr/sbin/svccfg import /opt/local/share/smf/manifest/$app_name-update.xml)
fi

if [[  "$(/usr/bin/svcs -Ho state ${app_name}-update)" != "online"  ]]; then
  echo "Enabling '${app_name}-update' service"
  $(/usr/sbin/svcadm enable -s ${app_name}-update)
fi


## Call the verify script
(cd /opt/smartdc/adminui && ./script/verify_setup.sh)
