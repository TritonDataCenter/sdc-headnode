How the USB headnode currently works:
-------------------------------------

GRUB is sitting in the boot sector of the USB stick. It loads, looks at
/boot/grub/menu.lst, which contains a pointer to /platform/...

Once booted, the 'joyinit' service calls a script (/lib/svc/method/svc-joyinit)
which will call the ur-agent.  The svc-joyinit script will see that
headnode=true is set in the boot parameters but there are no zpools and will
pass through a INITIAL_SCRIPT="/mnt/scripts/headnode.sh" environment variable to
the ur-agent.  The ur-agent will then execute this script as though it had
received it from rabbitmq and then restart itself (the joyinit service).
Assuming all the zones were created correctly this restart should allow the
ur-agent to connect to rabbitmq.

The USB stick is only mounted if it contains /.joyliveusb this is to prevent a
second USB key or a CDROM from being mounted at /mnt.

The zones are defined by zones/config/${zonename} , and need to have a
corresponding zones/fs/${zonename}.tar.bz as an overlay of the filesystem. it
contains /etc/hosts to define the name ( so that the network service can bring
up the interface ) as well as anything else that needs to be in the zone ( for
example ISC-DHCPD )

Directory structure
-------------------

/.joyliveusb
/bare.zfs.bz2
/boot
/boot/grub
/boot/grub/stage2
/boot/grub/menu.lst
/config
/platform
/platform/i86pc
/platform/i86pc/amd64
/platform/i86pc/amd64/boot_archive
/platform/i86pc/kernel
/platform/i86pc/kernel/amd64
/platform/i86pc/kernel/amd64/unix
/zones
/zones/config
/zones/config/${zone name}
/zones/fs
/zones/fs/${zone name}.tar.bz2

Building
--------

To build the VMware image, you will need to be on a Mac with MacFUSE 
installed.  To build it, run this from the repo's top-level directory

  $ ./bin/build-image

Notes:
-----

The vmware/USB-Headnode.vmwarevm.tbz2 file is a 4GB disk image with a FAT32
partition containing only grub.  It is intended to be used as a template.

GRUB needs to currently be installed via Linux. Once the USB stick is bootable
via grub copy the platform directory to the root of the USB stick.

boot/grub/menu.lst belongs to the headnode, so it passes -B headnode=true to the
headnode. 

The DHCP zone's tarball contains a /tftpboot directory that contains pxegrub and
boot/grub/menu.lst. platform is mounted from the USB key by zones
(zones/config/dhcp contains a 'fs' definition that mounts /mnt/platform to
/tftpboot/platform )

The dhcp.tar.bz2 file is on assets.joyent.us

The root level 'config' file sets the network interface.  See the
https://hub.joyent.com/wiki/display/dev/Live+Image page in the wiki for more
information on configuration options.

bare.zfs.bz2 comes from
https://guest:GrojhykMid@coal.joyent.us/coal/templates/bare-1.1.6.zfs.gz .
There's a bug in gzcat so you'll need to manually gunzip & then bzip2

to create the USB key the USB_KEY environment variable needs to be set
pointing at /dev/rdsk/<usb key>p0

USB key creation currently only works on Solaris-ish
