#!/bin/bash
#
# Copyright (c) 2010,2011 Joyent Inc., All rights reserved.
#

SUCMD='sudo'
MNT_DIR="/Volumes/USB-headnode.vmdk"
MD5CMD="md5 -r"
GZCAT=gzcat
TAR=tar
IMG_TYPE="coal" # if we're VMWare we're COAL
SUDO_PROMPT="[sudo] Password: "; export SUDO_PROMPT

function can_has_internets
{
    if ping -o -c 5 8.8.8.8 >/dev/null 2>&1 \
        || ping -o -c 5 4.2.2.1 >/dev/null 2>&1; then

        return 0
    fi
    return 1
}

function version
{
    echo "==> Building with variables from include-osx-vmware"
}

function cleanup
{
    if [ ${CLEANED} -eq 0 ]; then
        echo '==> Cleaning up'
        # Ensure we've unmounted the disk
        fusepath=$(/sbin/mount|grep vmware-vmdkMounterTool|awk '{print $3}')
        if [ -n "$fusepath" ]; then
          sync; sync; sync
          ${SUCMD} diskutil umount force "$fusepath"
          # Let's be polite with the Mac umounting ...
          sleep 3
        fi
        CLEANED=1

        if [ $ERROR -eq 0 ]; then
            echo "==> Defragmenting VMDK"
            ${SUCMD} \
              /Library/Application\ Support/VMware\ Fusion/vmware-vdiskmanager \
              -d ${ROOT}/cache/USB-headnode.vmwarevm/USB-headnode.vmdk
        fi
    fi
    rm -rf /tmp/fs.*.$$
}

function unpack_image
{
    echo -n "==> Unpacking VMWare image... "
    rm -rf ${ROOT}/cache/USB-headnode.vmwarevm
    (cd ${ROOT}/cache && ${TAR} -jxvf ${ROOT}/vmware/USB-headnode.vmwarevm.tbz2) \
        || fatal "Unable to unpack image"
    echo "done."
}

function mount_image
{
    echo -n "==> Mounting new VMWare image... "
    # Mount the disk as '/Volumes/USB-headnode.vmdk':
    # Delete a possible hanger-on from previous build, else the new one will
    # be mounted as "/Volumes/USB-headnode.vmdk 1".
    rm -rf "${MNT_DIR}"
    # This is not linux, waiting for the volume to be mounted:
    ${SUCMD} open -a \
        /Library/Application\ Support/VMWare\ Fusion/VMDKMounter.app \
        ${ROOT}/cache/USB-headnode.vmwarevm/USB-headnode.vmdk
    sleep 5
    echo "done."
}

function add_manifests
{
    # build manifest of USB files + move in boot_archive manifest
    rm -f ${ROOT}/cache/usb_key.manifest
    (cd ${STAGE}/ \
        && find . -type f -exec ${MD5CMD} {} \;) \
        > ${ROOT}/cache/USB-headnode.vmwarevm/usb_key.manifest
    [[ $? -eq 0 ]] || fatal "Unable to add md5 manifest"
    mv -f ${STAGE}/os/${LIVEIMG_VERSION}/platform/i86pc/amd64/boot_archive.manifest \
        ${ROOT}/cache/USB-headnode.vmwarevm/boot_archive.manifest
    chmod 444 ${ROOT}/cache/USB-headnode.vmwarevm/boot_archive.manifest \
        ${ROOT}/cache/USB-headnode.vmwarevm/usb_key.manifest
}

function create_output
{
    echo "==> Checking current GIT branch"
    branch_name="$(git symbolic-ref HEAD 2>/dev/null)" \
        || branch_name="(unnamed branch)"     # detached HEAD
    branch_name=${branch_name##refs/heads/}

    if [[ "$branch_name" != "master" ]]; then
      output_version="${branch_name}-${LIVEIMG_VERSION}"
    else
      output_version="${LIVEIMG_VERSION}"
    fi

    if [ -f build-number.txt ]; then
      output_version="$output_version-$(cat build-number.txt \
          | sed -n 's,^build\.number=\(.*\),\1,p')"
    fi

    if [[ -f ${ROOT}/cache/stage/private/root.password.${LIVEIMG_VERSION} ]]; then
        echo "==> Copying root.password.${LIVEIMG_VERSION}"
        ${SUCMD} cp ${ROOT}/cache/stage/private/root.password.${LIVEIMG_VERSION} \
            ${ROOT}/cache/USB-headnode.vmwarevm/root.password.${LIVEIMG_VERSION}
        ${SUCMD} chmod 400 ${ROOT}/cache/USB-headnode.vmwarevm/root.password.${LIVEIMG_VERSION}
    fi

    if [[ -z ${BUILD_TGZ} ]] || [[ ${BUILD_TGZ} != "false" ]]; then
        echo "==> Creating coal-147-${output_version}.tgz"
        (cd ${ROOT}/cache \
            && ${SUCMD} chown -R ${USER} USB-headnode.vmwarevm \
            && ${TAR} -zcf ${ROOT}/coal-147-${output_version}.tgz \
            USB-headnode.vmwarevm) \
            || fatal "Unable to create .tgz output file."
    else
        mv ${ROOT}/cache/USB-headnode.vmwarevm \
            coal-147-${output_version}.vmwarevm
        ${SUCMD} chown -R ${USER} coal-147-${output_version}.vmwarevm
    fi

}
