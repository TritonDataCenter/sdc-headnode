#!/bin/bash
#
# Copyright (c) 2010,2011 Joyent Inc., All rights reserved.
#

#
# We set errexit (a.k.a. "set -e") to force an exit on error conditions, but
# there are many important error conditions that this does not capture --
# first among them failures within a pipeline (only the exit status of the
# final stage is propagated).  To exit on these failures, we also set
# "pipefail" (a very useful option introduced to bash as of version 3 that
# propagates any non-zero exit values in a pipeline).
#

#export PS4='+(${BASH_SOURCE}:${LINENO}): ${SECONDS} ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
#set -o xtrace

set -o errexit
set -o pipefail

# write output to log file
ROOT=$(cd $(dirname $0)/../; pwd)

stagedir=

while [[ $# > 2 ]]; do
    option=$1
    shift
    case $option in
        -s)
            stagedir=$1
            shift
        ;;
        *)
            echo "Unknown option '$option'"
            exit 1
        ;;
    esac
done

ZONE=$1
CHECKOUT_TARGET=$2
ERR=


ZONEDIR="${ROOT}/zones/${ZONE}"
[[ -z $stagedir ]] && stagedir=$ZONEDIR

if [[ -z ${ZONE} || ! -d $stagedir ]]; then
    echo "No such zone '${ZONE}'"
    ERR=1
fi

#if [[ -z $CHECKOUT_TARGET ]]; then
#    echo "No checkout target specified '$CHECKOUT_TARGET'"
#    ERR=4
#fi

echo "$ZONE - ${stagedir}"
if [[ ! -x ${stagedir}/fs.populate ]]; then
    echo "Zone '${ZONE}' has no fs.populate script"
    ERR=2
fi
if [[ ! -d ${stagedir}/fs.root ]]; then
    echo "Zone '${ZONE}' has no fs.root dir"
    ERR=3
fi

if [[ -n ${ERR} ]]; then
    echo "Usage: $0 [-s <stage_dir>] <zone> <checkout_target>"
    exit 1
fi

if [[ ! -d $stagedir ]]; then
    export ADMINUI_DIR=${stagedir}/mcp_api_admin
    export BOOTER_DIR=${stagedir}/booter
    export MAPI_DIR=${stagedir}/mcp_api_gateway
    export PORTAL_DIR=${stagedir}/public-web-client
    export CLOUDAPI_DIR=${stagedir}/cloud-api
    export BILLAPI_DIR=${stagedir}/billing_api
    export UFDS_DIR=${stagedir}/ufds
fi

# do in /tmp because only root can write in mnt
fstar=$stagedir/fs.tar.bz2
rm -f ${fstar}
mkdir -p /tmp/fs.${ZONE}.$$
cp -pPR ${stagedir}/fs.populate ${stagedir}/fs.root /tmp/fs.${ZONE}.$$
(cd /tmp/fs.${ZONE}.$$/fs.root \
    && CHECKOUT_TARGET=$CHECKOUT_TARGET ../fs.populate \
    && tar -jcvf ${fstar} ./ )
rm -rf /tmp/fs.${ZONE}.$$
if [[ $? -ne 0 ]]; then
    fatal "Failed create ${ZONE}.tar.bz2 for ${ZONE}"
else
    echo "Created '${fstar}'."
fi

exit 0
